"use strict";
Object.defineProperty(exports, "__esModule", {
    value: true
});
Object.defineProperty(exports, "default", {
    enumerable: true,
    get: function() {
        return _default;
    }
});
const _jsonwebtoken = /*#__PURE__*/ _interop_require_default(require("jsonwebtoken"));
const _utils = require("../../collections/operations/utils");
const _errors = require("../../errors");
const _afterRead = require("../../fields/hooks/afterRead");
const _commitTransaction = require("../../utilities/commitTransaction");
const _getCookieExpiration = /*#__PURE__*/ _interop_require_default(require("../../utilities/getCookieExpiration"));
const _initTransaction = require("../../utilities/initTransaction");
const _killTransaction = require("../../utilities/killTransaction");
const _sanitizeInternalFields = /*#__PURE__*/ _interop_require_default(require("../../utilities/sanitizeInternalFields"));
const _isLocked = /*#__PURE__*/ _interop_require_default(require("../isLocked"));
const _authenticate = require("../strategies/local/authenticate");
const _incrementLoginAttempts = require("../strategies/local/incrementLoginAttempts");
const _resetLoginAttempts = require("../strategies/local/resetLoginAttempts");
const _getFieldsToSign = require("./getFieldsToSign");
function _interop_require_default(obj) {
    return obj && obj.__esModule ? obj : {
        default: obj
    };
}
async function login(incomingArgs) {
    let args = incomingArgs;
    // /////////////////////////////////////
    // beforeOperation - Collection
    // /////////////////////////////////////
    await args.collection.config.hooks.beforeOperation.reduce(async (priorHook, hook)=>{
        await priorHook;
        args = await hook({
            args,
            collection: args.collection?.config,
            context: args.req.context,
            operation: 'login'
        }) || args;
    }, Promise.resolve());
    const { collection: { config: collectionConfig }, data, depth, overrideAccess, req, req: { payload, payload: { config, secret } }, showHiddenFields } = args;
    try {
        const shouldCommit = await (0, _initTransaction.initTransaction)(req);
        // /////////////////////////////////////
        // Login
        // /////////////////////////////////////
        const { email: unsanitizedEmail, password } = data;
        const email = unsanitizedEmail ? unsanitizedEmail.toLowerCase().trim() : null;
        let user = await payload.db.findOne({
            collection: collectionConfig.slug,
            req,
            where: {
                email: {
                    equals: email.toLowerCase()
                }
            }
        });
        if (!user || args.collection.config.auth.verify && user._verified === false) {
            throw new _errors.AuthenticationError(req.t);
        }
        if (user && (0, _isLocked.default)(user.lockUntil)) {
            throw new _errors.LockedAuth(req.t);
        }
        const authResult = await (0, _authenticate.authenticateLocalStrategy)({
            doc: user,
            password
        });
        user = (0, _sanitizeInternalFields.default)(user);
        const maxLoginAttemptsEnabled = args.collection.config.auth.maxLoginAttempts > 0;
        if (!authResult) {
            if (maxLoginAttemptsEnabled) {
                await (0, _incrementLoginAttempts.incrementLoginAttempts)({
                    collection: collectionConfig,
                    doc: user,
                    payload: req.payload,
                    req
                });
            }
            if (shouldCommit) await (0, _commitTransaction.commitTransaction)(req);
            throw new _errors.AuthenticationError(req.t);
        }
        if (maxLoginAttemptsEnabled) {
            await (0, _resetLoginAttempts.resetLoginAttempts)({
                collection: collectionConfig,
                doc: user,
                payload: req.payload,
                req
            });
        }
        const fieldsToSign = (0, _getFieldsToSign.getFieldsToSign)({
            collectionConfig,
            email,
            user
        });
        await collectionConfig.hooks.beforeLogin.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: args.req.context,
                req: args.req,
                user
            }) || user;
        }, Promise.resolve());
        const token = _jsonwebtoken.default.sign(fieldsToSign, secret, {
            expiresIn: collectionConfig.auth.tokenExpiration
        });
        if (args.res) {
            const cookieOptions = {
                domain: undefined,
                expires: (0, _getCookieExpiration.default)(collectionConfig.auth.tokenExpiration),
                httpOnly: true,
                path: '/',
                sameSite: collectionConfig.auth.cookies.sameSite,
                secure: collectionConfig.auth.cookies.secure
            };
            if (collectionConfig.auth.cookies.domain) cookieOptions.domain = collectionConfig.auth.cookies.domain;
            args.res.cookie(`${config.cookiePrefix}-token`, token, cookieOptions);
        }
        req.user = user;
        // /////////////////////////////////////
        // afterLogin - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterLogin.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: args.req.context,
                req: args.req,
                token,
                user
            }) || user;
        }, Promise.resolve());
        // /////////////////////////////////////
        // afterRead - Fields
        // /////////////////////////////////////
        user = await (0, _afterRead.afterRead)({
            collection: collectionConfig,
            context: req.context,
            depth,
            doc: user,
            global: null,
            overrideAccess,
            req,
            showHiddenFields
        });
        // /////////////////////////////////////
        // afterRead - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterRead.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: req.context,
                doc: user,
                req
            }) || user;
        }, Promise.resolve());
        // /////////////////////////////////////
        // afterRead - Collection
        // /////////////////////////////////////
        await collectionConfig.hooks.afterRead.reduce(async (priorHook, hook)=>{
            await priorHook;
            user = await hook({
                collection: args.collection?.config,
                context: req.context,
                doc: user,
                req
            }) || user;
        }, Promise.resolve());
        let result = {
            exp: _jsonwebtoken.default.decode(token).exp,
            token,
            user
        };
        // /////////////////////////////////////
        // afterOperation - Collection
        // /////////////////////////////////////
        result = await (0, _utils.buildAfterOperation)({
            args,
            collection: args.collection?.config,
            operation: 'login',
            result
        });
        if (collectionConfig.auth.removeTokenFromResponses) {
            delete result.token;
        }
        // /////////////////////////////////////
        // Return results
        // /////////////////////////////////////
        if (shouldCommit) await (0, _commitTransaction.commitTransaction)(req);
        return result;
    } catch (error) {
        await (0, _killTransaction.killTransaction)(req);
        throw error;
    }
}
const _default = login;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hdXRoL29wZXJhdGlvbnMvbG9naW4udHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHR5cGUgeyBDb29raWVPcHRpb25zLCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnXG5cbmltcG9ydCBqd3QgZnJvbSAnanNvbndlYnRva2VuJ1xuXG5pbXBvcnQgdHlwZSB7IEdlbmVyYXRlZFR5cGVzIH0gZnJvbSAnLi4vLi4vJ1xuaW1wb3J0IHR5cGUgeyBDb2xsZWN0aW9uIH0gZnJvbSAnLi4vLi4vY29sbGVjdGlvbnMvY29uZmlnL3R5cGVzJ1xuaW1wb3J0IHR5cGUgeyBQYXlsb2FkUmVxdWVzdCB9IGZyb20gJy4uLy4uL2V4cHJlc3MvdHlwZXMnXG5pbXBvcnQgdHlwZSB7IFVzZXIgfSBmcm9tICcuLi90eXBlcydcblxuaW1wb3J0IHsgYnVpbGRBZnRlck9wZXJhdGlvbiB9IGZyb20gJy4uLy4uL2NvbGxlY3Rpb25zL29wZXJhdGlvbnMvdXRpbHMnXG5pbXBvcnQgeyBBdXRoZW50aWNhdGlvbkVycm9yLCBMb2NrZWRBdXRoIH0gZnJvbSAnLi4vLi4vZXJyb3JzJ1xuaW1wb3J0IHsgYWZ0ZXJSZWFkIH0gZnJvbSAnLi4vLi4vZmllbGRzL2hvb2tzL2FmdGVyUmVhZCdcbmltcG9ydCB7IGNvbW1pdFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2NvbW1pdFRyYW5zYWN0aW9uJ1xuaW1wb3J0IGdldENvb2tpZUV4cGlyYXRpb24gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2dldENvb2tpZUV4cGlyYXRpb24nXG5pbXBvcnQgeyBpbml0VHJhbnNhY3Rpb24gfSBmcm9tICcuLi8uLi91dGlsaXRpZXMvaW5pdFRyYW5zYWN0aW9uJ1xuaW1wb3J0IHsga2lsbFRyYW5zYWN0aW9uIH0gZnJvbSAnLi4vLi4vdXRpbGl0aWVzL2tpbGxUcmFuc2FjdGlvbidcbmltcG9ydCBzYW5pdGl6ZUludGVybmFsRmllbGRzIGZyb20gJy4uLy4uL3V0aWxpdGllcy9zYW5pdGl6ZUludGVybmFsRmllbGRzJ1xuaW1wb3J0IGlzTG9ja2VkIGZyb20gJy4uL2lzTG9ja2VkJ1xuaW1wb3J0IHsgYXV0aGVudGljYXRlTG9jYWxTdHJhdGVneSB9IGZyb20gJy4uL3N0cmF0ZWdpZXMvbG9jYWwvYXV0aGVudGljYXRlJ1xuaW1wb3J0IHsgaW5jcmVtZW50TG9naW5BdHRlbXB0cyB9IGZyb20gJy4uL3N0cmF0ZWdpZXMvbG9jYWwvaW5jcmVtZW50TG9naW5BdHRlbXB0cydcbmltcG9ydCB7IHJlc2V0TG9naW5BdHRlbXB0cyB9IGZyb20gJy4uL3N0cmF0ZWdpZXMvbG9jYWwvcmVzZXRMb2dpbkF0dGVtcHRzJ1xuaW1wb3J0IHsgZ2V0RmllbGRzVG9TaWduIH0gZnJvbSAnLi9nZXRGaWVsZHNUb1NpZ24nXG5cbmV4cG9ydCB0eXBlIFJlc3VsdCA9IHtcbiAgZXhwPzogbnVtYmVyXG4gIHRva2VuPzogc3RyaW5nXG4gIHVzZXI/OiBVc2VyXG59XG5cbmV4cG9ydCB0eXBlIEFyZ3VtZW50cyA9IHtcbiAgY29sbGVjdGlvbjogQ29sbGVjdGlvblxuICBkYXRhOiB7XG4gICAgZW1haWw6IHN0cmluZ1xuICAgIHBhc3N3b3JkOiBzdHJpbmdcbiAgfVxuICBkZXB0aD86IG51bWJlclxuICBvdmVycmlkZUFjY2Vzcz86IGJvb2xlYW5cbiAgcmVxOiBQYXlsb2FkUmVxdWVzdFxuICByZXM/OiBSZXNwb25zZVxuICBzaG93SGlkZGVuRmllbGRzPzogYm9vbGVhblxufVxuXG5hc3luYyBmdW5jdGlvbiBsb2dpbjxUU2x1ZyBleHRlbmRzIGtleW9mIEdlbmVyYXRlZFR5cGVzWydjb2xsZWN0aW9ucyddPihcbiAgaW5jb21pbmdBcmdzOiBBcmd1bWVudHMsXG4pOiBQcm9taXNlPFJlc3VsdCAmIHsgdXNlcjogR2VuZXJhdGVkVHlwZXNbJ2NvbGxlY3Rpb25zJ11bVFNsdWddIH0+IHtcbiAgbGV0IGFyZ3MgPSBpbmNvbWluZ0FyZ3NcblxuICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vIGJlZm9yZU9wZXJhdGlvbiAtIENvbGxlY3Rpb25cbiAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gIGF3YWl0IGFyZ3MuY29sbGVjdGlvbi5jb25maWcuaG9va3MuYmVmb3JlT3BlcmF0aW9uLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgYXdhaXQgcHJpb3JIb29rXG5cbiAgICBhcmdzID1cbiAgICAgIChhd2FpdCBob29rKHtcbiAgICAgICAgYXJncyxcbiAgICAgICAgY29sbGVjdGlvbjogYXJncy5jb2xsZWN0aW9uPy5jb25maWcsXG4gICAgICAgIGNvbnRleHQ6IGFyZ3MucmVxLmNvbnRleHQsXG4gICAgICAgIG9wZXJhdGlvbjogJ2xvZ2luJyxcbiAgICAgIH0pKSB8fCBhcmdzXG4gIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuXG4gIGNvbnN0IHtcbiAgICBjb2xsZWN0aW9uOiB7IGNvbmZpZzogY29sbGVjdGlvbkNvbmZpZyB9LFxuICAgIGRhdGEsXG4gICAgZGVwdGgsXG4gICAgb3ZlcnJpZGVBY2Nlc3MsXG4gICAgcmVxLFxuICAgIHJlcToge1xuICAgICAgcGF5bG9hZCxcbiAgICAgIHBheWxvYWQ6IHsgY29uZmlnLCBzZWNyZXQgfSxcbiAgICB9LFxuICAgIHNob3dIaWRkZW5GaWVsZHMsXG4gIH0gPSBhcmdzXG5cbiAgdHJ5IHtcbiAgICBjb25zdCBzaG91bGRDb21taXQgPSBhd2FpdCBpbml0VHJhbnNhY3Rpb24ocmVxKVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIExvZ2luXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgY29uc3QgeyBlbWFpbDogdW5zYW5pdGl6ZWRFbWFpbCwgcGFzc3dvcmQgfSA9IGRhdGFcblxuICAgIGNvbnN0IGVtYWlsID0gdW5zYW5pdGl6ZWRFbWFpbCA/IHVuc2FuaXRpemVkRW1haWwudG9Mb3dlckNhc2UoKS50cmltKCkgOiBudWxsXG5cbiAgICBsZXQgdXNlciA9IGF3YWl0IHBheWxvYWQuZGIuZmluZE9uZTxhbnk+KHtcbiAgICAgIGNvbGxlY3Rpb246IGNvbGxlY3Rpb25Db25maWcuc2x1ZyxcbiAgICAgIHJlcSxcbiAgICAgIHdoZXJlOiB7IGVtYWlsOiB7IGVxdWFsczogZW1haWwudG9Mb3dlckNhc2UoKSB9IH0sXG4gICAgfSlcblxuICAgIGlmICghdXNlciB8fCAoYXJncy5jb2xsZWN0aW9uLmNvbmZpZy5hdXRoLnZlcmlmeSAmJiB1c2VyLl92ZXJpZmllZCA9PT0gZmFsc2UpKSB7XG4gICAgICB0aHJvdyBuZXcgQXV0aGVudGljYXRpb25FcnJvcihyZXEudClcbiAgICB9XG5cbiAgICBpZiAodXNlciAmJiBpc0xvY2tlZCh1c2VyLmxvY2tVbnRpbCkpIHtcbiAgICAgIHRocm93IG5ldyBMb2NrZWRBdXRoKHJlcS50KVxuICAgIH1cblxuICAgIGNvbnN0IGF1dGhSZXN1bHQgPSBhd2FpdCBhdXRoZW50aWNhdGVMb2NhbFN0cmF0ZWd5KHsgZG9jOiB1c2VyLCBwYXNzd29yZCB9KVxuXG4gICAgdXNlciA9IHNhbml0aXplSW50ZXJuYWxGaWVsZHModXNlcilcblxuICAgIGNvbnN0IG1heExvZ2luQXR0ZW1wdHNFbmFibGVkID0gYXJncy5jb2xsZWN0aW9uLmNvbmZpZy5hdXRoLm1heExvZ2luQXR0ZW1wdHMgPiAwXG5cbiAgICBpZiAoIWF1dGhSZXN1bHQpIHtcbiAgICAgIGlmIChtYXhMb2dpbkF0dGVtcHRzRW5hYmxlZCkge1xuICAgICAgICBhd2FpdCBpbmNyZW1lbnRMb2dpbkF0dGVtcHRzKHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uQ29uZmlnLFxuICAgICAgICAgIGRvYzogdXNlcixcbiAgICAgICAgICBwYXlsb2FkOiByZXEucGF5bG9hZCxcbiAgICAgICAgICByZXEsXG4gICAgICAgIH0pXG4gICAgICB9XG5cbiAgICAgIGlmIChzaG91bGRDb21taXQpIGF3YWl0IGNvbW1pdFRyYW5zYWN0aW9uKHJlcSlcblxuICAgICAgdGhyb3cgbmV3IEF1dGhlbnRpY2F0aW9uRXJyb3IocmVxLnQpXG4gICAgfVxuXG4gICAgaWYgKG1heExvZ2luQXR0ZW1wdHNFbmFibGVkKSB7XG4gICAgICBhd2FpdCByZXNldExvZ2luQXR0ZW1wdHMoe1xuICAgICAgICBjb2xsZWN0aW9uOiBjb2xsZWN0aW9uQ29uZmlnLFxuICAgICAgICBkb2M6IHVzZXIsXG4gICAgICAgIHBheWxvYWQ6IHJlcS5wYXlsb2FkLFxuICAgICAgICByZXEsXG4gICAgICB9KVxuICAgIH1cblxuICAgIGNvbnN0IGZpZWxkc1RvU2lnbiA9IGdldEZpZWxkc1RvU2lnbih7XG4gICAgICBjb2xsZWN0aW9uQ29uZmlnLFxuICAgICAgZW1haWwsXG4gICAgICB1c2VyLFxuICAgIH0pXG5cbiAgICBhd2FpdCBjb2xsZWN0aW9uQ29uZmlnLmhvb2tzLmJlZm9yZUxvZ2luLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgICAgdXNlciA9XG4gICAgICAgIChhd2FpdCBob29rKHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiBhcmdzLmNvbGxlY3Rpb24/LmNvbmZpZyxcbiAgICAgICAgICBjb250ZXh0OiBhcmdzLnJlcS5jb250ZXh0LFxuICAgICAgICAgIHJlcTogYXJncy5yZXEsXG4gICAgICAgICAgdXNlcixcbiAgICAgICAgfSkpIHx8IHVzZXJcbiAgICB9LCBQcm9taXNlLnJlc29sdmUoKSlcblxuICAgIGNvbnN0IHRva2VuID0gand0LnNpZ24oZmllbGRzVG9TaWduLCBzZWNyZXQsIHtcbiAgICAgIGV4cGlyZXNJbjogY29sbGVjdGlvbkNvbmZpZy5hdXRoLnRva2VuRXhwaXJhdGlvbixcbiAgICB9KVxuXG4gICAgaWYgKGFyZ3MucmVzKSB7XG4gICAgICBjb25zdCBjb29raWVPcHRpb25zOiBDb29raWVPcHRpb25zID0ge1xuICAgICAgICBkb21haW46IHVuZGVmaW5lZCxcbiAgICAgICAgZXhwaXJlczogZ2V0Q29va2llRXhwaXJhdGlvbihjb2xsZWN0aW9uQ29uZmlnLmF1dGgudG9rZW5FeHBpcmF0aW9uKSxcbiAgICAgICAgaHR0cE9ubHk6IHRydWUsXG4gICAgICAgIHBhdGg6ICcvJyxcbiAgICAgICAgc2FtZVNpdGU6IGNvbGxlY3Rpb25Db25maWcuYXV0aC5jb29raWVzLnNhbWVTaXRlLFxuICAgICAgICBzZWN1cmU6IGNvbGxlY3Rpb25Db25maWcuYXV0aC5jb29raWVzLnNlY3VyZSxcbiAgICAgIH1cblxuICAgICAgaWYgKGNvbGxlY3Rpb25Db25maWcuYXV0aC5jb29raWVzLmRvbWFpbilcbiAgICAgICAgY29va2llT3B0aW9ucy5kb21haW4gPSBjb2xsZWN0aW9uQ29uZmlnLmF1dGguY29va2llcy5kb21haW5cblxuICAgICAgYXJncy5yZXMuY29va2llKGAke2NvbmZpZy5jb29raWVQcmVmaXh9LXRva2VuYCwgdG9rZW4sIGNvb2tpZU9wdGlvbnMpXG4gICAgfVxuXG4gICAgcmVxLnVzZXIgPSB1c2VyXG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gYWZ0ZXJMb2dpbiAtIENvbGxlY3Rpb25cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5cbiAgICBhd2FpdCBjb2xsZWN0aW9uQ29uZmlnLmhvb2tzLmFmdGVyTG9naW4ucmVkdWNlKGFzeW5jIChwcmlvckhvb2ssIGhvb2spID0+IHtcbiAgICAgIGF3YWl0IHByaW9ySG9va1xuXG4gICAgICB1c2VyID1cbiAgICAgICAgKGF3YWl0IGhvb2soe1xuICAgICAgICAgIGNvbGxlY3Rpb246IGFyZ3MuY29sbGVjdGlvbj8uY29uZmlnLFxuICAgICAgICAgIGNvbnRleHQ6IGFyZ3MucmVxLmNvbnRleHQsXG4gICAgICAgICAgcmVxOiBhcmdzLnJlcSxcbiAgICAgICAgICB0b2tlbixcbiAgICAgICAgICB1c2VyLFxuICAgICAgICB9KSkgfHwgdXNlclxuICAgIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIGFmdGVyUmVhZCAtIEZpZWxkc1xuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIHVzZXIgPSBhd2FpdCBhZnRlclJlYWQoe1xuICAgICAgY29sbGVjdGlvbjogY29sbGVjdGlvbkNvbmZpZyxcbiAgICAgIGNvbnRleHQ6IHJlcS5jb250ZXh0LFxuICAgICAgZGVwdGgsXG4gICAgICBkb2M6IHVzZXIsXG4gICAgICBnbG9iYWw6IG51bGwsXG4gICAgICBvdmVycmlkZUFjY2VzcyxcbiAgICAgIHJlcSxcbiAgICAgIHNob3dIaWRkZW5GaWVsZHMsXG4gICAgfSlcblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgICAvLyBhZnRlclJlYWQgLSBDb2xsZWN0aW9uXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgYXdhaXQgY29sbGVjdGlvbkNvbmZpZy5ob29rcy5hZnRlclJlYWQucmVkdWNlKGFzeW5jIChwcmlvckhvb2ssIGhvb2spID0+IHtcbiAgICAgIGF3YWl0IHByaW9ySG9va1xuXG4gICAgICB1c2VyID1cbiAgICAgICAgKGF3YWl0IGhvb2soe1xuICAgICAgICAgIGNvbGxlY3Rpb246IGFyZ3MuY29sbGVjdGlvbj8uY29uZmlnLFxuICAgICAgICAgIGNvbnRleHQ6IHJlcS5jb250ZXh0LFxuICAgICAgICAgIGRvYzogdXNlcixcbiAgICAgICAgICByZXEsXG4gICAgICAgIH0pKSB8fCB1c2VyXG4gICAgfSwgUHJvbWlzZS5yZXNvbHZlKCkpXG5cbiAgICAvLyAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gICAgLy8gYWZ0ZXJSZWFkIC0gQ29sbGVjdGlvblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIGF3YWl0IGNvbGxlY3Rpb25Db25maWcuaG9va3MuYWZ0ZXJSZWFkLnJlZHVjZShhc3luYyAocHJpb3JIb29rLCBob29rKSA9PiB7XG4gICAgICBhd2FpdCBwcmlvckhvb2tcblxuICAgICAgdXNlciA9XG4gICAgICAgIChhd2FpdCBob29rKHtcbiAgICAgICAgICBjb2xsZWN0aW9uOiBhcmdzLmNvbGxlY3Rpb24/LmNvbmZpZyxcbiAgICAgICAgICBjb250ZXh0OiByZXEuY29udGV4dCxcbiAgICAgICAgICBkb2M6IHVzZXIsXG4gICAgICAgICAgcmVxLFxuICAgICAgICB9KSkgfHwgdXNlclxuICAgIH0sIFByb21pc2UucmVzb2x2ZSgpKVxuXG4gICAgbGV0IHJlc3VsdDogUmVzdWx0ICYgeyB1c2VyOiBHZW5lcmF0ZWRUeXBlc1snY29sbGVjdGlvbnMnXVtUU2x1Z10gfSA9IHtcbiAgICAgIGV4cDogKGp3dC5kZWNvZGUodG9rZW4pIGFzIGp3dC5Kd3RQYXlsb2FkKS5leHAsXG4gICAgICB0b2tlbixcbiAgICAgIHVzZXIsXG4gICAgfVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIGFmdGVyT3BlcmF0aW9uIC0gQ29sbGVjdGlvblxuICAgIC8vIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cblxuICAgIHJlc3VsdCA9IGF3YWl0IGJ1aWxkQWZ0ZXJPcGVyYXRpb248R2VuZXJhdGVkVHlwZXNbJ2NvbGxlY3Rpb25zJ11bVFNsdWddPih7XG4gICAgICBhcmdzLFxuICAgICAgY29sbGVjdGlvbjogYXJncy5jb2xsZWN0aW9uPy5jb25maWcsXG4gICAgICBvcGVyYXRpb246ICdsb2dpbicsXG4gICAgICByZXN1bHQsXG4gICAgfSlcblxuICAgIGlmIChjb2xsZWN0aW9uQ29uZmlnLmF1dGgucmVtb3ZlVG9rZW5Gcm9tUmVzcG9uc2VzKSB7XG4gICAgICBkZWxldGUgcmVzdWx0LnRva2VuXG4gICAgfVxuXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAgIC8vIFJldHVybiByZXN1bHRzXG4gICAgLy8gLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuXG4gICAgaWYgKHNob3VsZENvbW1pdCkgYXdhaXQgY29tbWl0VHJhbnNhY3Rpb24ocmVxKVxuXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9IGNhdGNoIChlcnJvcjogdW5rbm93bikge1xuICAgIGF3YWl0IGtpbGxUcmFuc2FjdGlvbihyZXEpXG4gICAgdGhyb3cgZXJyb3JcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBsb2dpblxuIl0sIm5hbWVzIjpbImxvZ2luIiwiaW5jb21pbmdBcmdzIiwiYXJncyIsImNvbGxlY3Rpb24iLCJjb25maWciLCJob29rcyIsImJlZm9yZU9wZXJhdGlvbiIsInJlZHVjZSIsInByaW9ySG9vayIsImhvb2siLCJjb250ZXh0IiwicmVxIiwib3BlcmF0aW9uIiwiUHJvbWlzZSIsInJlc29sdmUiLCJjb2xsZWN0aW9uQ29uZmlnIiwiZGF0YSIsImRlcHRoIiwib3ZlcnJpZGVBY2Nlc3MiLCJwYXlsb2FkIiwic2VjcmV0Iiwic2hvd0hpZGRlbkZpZWxkcyIsInNob3VsZENvbW1pdCIsImluaXRUcmFuc2FjdGlvbiIsImVtYWlsIiwidW5zYW5pdGl6ZWRFbWFpbCIsInBhc3N3b3JkIiwidG9Mb3dlckNhc2UiLCJ0cmltIiwidXNlciIsImRiIiwiZmluZE9uZSIsInNsdWciLCJ3aGVyZSIsImVxdWFscyIsImF1dGgiLCJ2ZXJpZnkiLCJfdmVyaWZpZWQiLCJBdXRoZW50aWNhdGlvbkVycm9yIiwidCIsImlzTG9ja2VkIiwibG9ja1VudGlsIiwiTG9ja2VkQXV0aCIsImF1dGhSZXN1bHQiLCJhdXRoZW50aWNhdGVMb2NhbFN0cmF0ZWd5IiwiZG9jIiwic2FuaXRpemVJbnRlcm5hbEZpZWxkcyIsIm1heExvZ2luQXR0ZW1wdHNFbmFibGVkIiwibWF4TG9naW5BdHRlbXB0cyIsImluY3JlbWVudExvZ2luQXR0ZW1wdHMiLCJjb21taXRUcmFuc2FjdGlvbiIsInJlc2V0TG9naW5BdHRlbXB0cyIsImZpZWxkc1RvU2lnbiIsImdldEZpZWxkc1RvU2lnbiIsImJlZm9yZUxvZ2luIiwidG9rZW4iLCJqd3QiLCJzaWduIiwiZXhwaXJlc0luIiwidG9rZW5FeHBpcmF0aW9uIiwicmVzIiwiY29va2llT3B0aW9ucyIsImRvbWFpbiIsInVuZGVmaW5lZCIsImV4cGlyZXMiLCJnZXRDb29raWVFeHBpcmF0aW9uIiwiaHR0cE9ubHkiLCJwYXRoIiwic2FtZVNpdGUiLCJjb29raWVzIiwic2VjdXJlIiwiY29va2llIiwiY29va2llUHJlZml4IiwiYWZ0ZXJMb2dpbiIsImFmdGVyUmVhZCIsImdsb2JhbCIsInJlc3VsdCIsImV4cCIsImRlY29kZSIsImJ1aWxkQWZ0ZXJPcGVyYXRpb24iLCJyZW1vdmVUb2tlbkZyb21SZXNwb25zZXMiLCJlcnJvciIsImtpbGxUcmFuc2FjdGlvbiJdLCJtYXBwaW5ncyI6Ijs7OzsrQkE2UUE7OztlQUFBOzs7cUVBM1FnQjt1QkFPb0I7d0JBQ1k7MkJBQ3RCO21DQUNROzRFQUNGO2lDQUNBO2lDQUNBOytFQUNHO2lFQUNkOzhCQUNxQjt3Q0FDSDtvQ0FDSjtpQ0FDSDs7Ozs7O0FBcUJoQyxlQUFlQSxNQUNiQyxZQUF1QjtJQUV2QixJQUFJQyxPQUFPRDtJQUVYLHdDQUF3QztJQUN4QywrQkFBK0I7SUFDL0Isd0NBQXdDO0lBRXhDLE1BQU1DLEtBQUtDLFVBQVUsQ0FBQ0MsTUFBTSxDQUFDQyxLQUFLLENBQUNDLGVBQWUsQ0FBQ0MsTUFBTSxDQUFDLE9BQU9DLFdBQVdDO1FBQzFFLE1BQU1EO1FBRU5OLE9BQ0UsQUFBQyxNQUFNTyxLQUFLO1lBQ1ZQO1lBQ0FDLFlBQVlELEtBQUtDLFVBQVUsRUFBRUM7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